<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SkyReserve</title>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="footer.css">

  <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>

<body>
  <!-- Header Section -->
  <header data-aos="fade-down" data-aos-duration="3000">
    <!-- Logo Section -->
    <h1 class="logo">SKYRESERVE</h1>
    <nav>
      <ul class="nav_links">
        <li><a href="TI/TI.html">Travel Info</a></li>
        <li><a href="About/About.html">About</a></li>
        <li><a href="login.html">Log In</a></li>
      </ul>
    </nav>
    <div class="menu-icon" id="menuIcon">
      <i class='bx bx-menu'></i>
    </div>
  </header>

  <!-- Main Section -->
  <main class="main-container">
    <section class="left-section" data-aos="fade-right" data-aos-duration="3000">
      <div class="content">
        <!-- Title Section -->
        <h1>From screen to sky,<br> effortlessly yours.</h1>
        <!-- Form Section -->
        <form id="bookingForm">

          <!-- Trip Section -->
          <div class="trip-type-wrapper">
            <div class="custom-select">
              <select name="trips" id="trips" required>
                <option value="" disabled selected>Select your trip</option>
                <option value="round-trip">Round-trip</option>
              </select>
              <i class='bx bx-chevron-down'></i>
            </div>
          </div>

          <div class="input-group">
            <!-- Departure Section -->
            <div class="input-wrapper">
              <label for="takeOff" class="input-label">From</label>
              <select id="takeOff" required>
                <option value="" disabled selected>Select departure</option>
              </select>
            </div>

            <div class="icon">
              <i class='bx bxs-plane-alt'></i>
            </div>

            <!-- Destination Section -->
            <div class="input-wrapper">
              <label for="arrival" class="input-label">To</label>
              <select id="arrival" required>
                <option value="" disabled selected>Select Destination</option>
              </select>
            </div>
          </div>

          <div class="input-group">
            <!-- Departure Date Section -->
            <div class="input-wrapper">
              <label for="departureDate" class="input-label">Depart</label>
              <input type="text" id="departureDate" name="date" placeholder="Depart" required>
            </div>

            <div class="icon">
              <i class='bx bxs-calendar'></i>
            </div>

            <!-- Return Date Section -->
            <div class="input-wrapper">
              <label for="returnDate" class="input-label">Return</label>
              <input type="text" id="returnDate" name="date" placeholder="Returning on" required>
            </div>
          </div>

          <!-- Button Section -->
          <button type="submit">Search flights</button>
        </form>
      </div>

      <!-- Slider Section -->
      <div class="slider">
        <div class="slider-header">
          <h2>Popular Destination</h2>
          <div class="slider-buttons">
            <button id="prev" class="slider-btn">
              <i class='bx bx-chevron-left'></i>
            </button>

            <button id="next" class="slider-btn">
              <i class='bx bx-chevron-right'></i>
            </button>
          </div>
        </div>

        <div class="slider-container">
          <div class="slider-images">

            <div class="slide">
              <img src="Images/china.jpg" alt="China">
              <div class="info">
                <p class="location">Beijing, China</p>
                <p class="sub-location">The Great Wall Adventure</p>
                <div class="price">
                  <span class="slide-icon"><i class='bx bxs-plane-take-off'></i></span>
                  <span>$430</span>
                </div>
              </div>
            </div>

            <div class="slide">
              <img src="Images/cyprus.jpg" alt="Cyprus">
              <div class="info">
                <p class="location">Paphos, Cyprus</p>
                <p class="sub-location">Mediterranean Getaway</p>
                <div class="price">
                  <span class="slide-icon"><i class='bx bxs-plane-take-off'></i></span>
                  <span>$520</span>
                </div>
              </div>
            </div>

            <div class="slide">
              <img src="Images/japan.jpg" alt="Japan">
              <div class="info">
                <p class="location">Tokyo, Japan</p>
                <p class="sub-location">Cherry Blossoms & Culture</p>
                <div class="price">
                  <span class="slide-icon"><i class='bx bxs-plane-take-off'></i></span>
                  <span>$480</span>
                </div>
              </div>
            </div>

            <div class="slide">
              <img src="Images/paris.jpg" alt="Paris">
              <div class="info">
                <p class="location">Paris, France</p>
                <p class="sub-location">City of Lights</p>
                <div class="price">
                  <span class="slide-icon"><i class='bx bxs-plane-take-off'></i></span>
                  <span>$610</span>
                </div>
              </div>
            </div>

            <div class="slide">
              <img src="Images/s.korea.jpg" alt="South Korea">
              <div class="info">
                <p class="location">Seoul, South Korea</p>
                <p class="sub-location">Tech & Tradition</p>
                <div class="price">
                  <span class="slide-icon"><i class='bx bxs-plane-take-off'></i></span>
                  <span>$450</span>
                </div>
              </div>
            </div>

            <div class="slide">
              <img src="Images/spain.jpg" alt="Spain">
              <div class="info">
                <p class="location">Barcelona, Spain</p>
                <p class="sub-location">Beach & Gothic Charm</p>
                <div class="price">
                  <span class="slide-icon"><i class='bx bxs-plane-take-off'></i></span>
                  <span>$560</span>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer Section -->
  <div id="footer-placeholder"></div>

  <script type="text/javascript" src="script.js"></script>
  <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
    // To animate
    AOS.init({ offset: 1 });

    document.addEventListener("DOMContentLoaded", () => {
        const today = new Date();

        // Initialize departure date picker (dual-calendar but single selection display)
        const departurePicker = flatpickr("#departureDate", {
            dateFormat: "d M Y",
            defaultDate: today,
            minDate: today,
            showMonths: 2, // Displays May & June side by side
            mode: "range", // Enables range selection but modifies input display
            onOpen: function (selectedDates, dateStr, instance) {
                try {
                    const calendarContainer = instance.calendarContainer;
                    if (calendarContainer) {
                        calendarContainer.classList.add("dual-calendar"); // Styling only for departure picker
                    }
                } catch (error) {
                    console.warn("Flatpickr styling error:", error);
                }
            },
            onChange: function (selectedDates) {
                if (selectedDates.length > 0) {
                    const departDate = selectedDates[0];

                    // Ensure return date starts in June while staying empty initially
                    returnPicker.set("minDate", departDate);

                    // Show only departure date in input (not full range)
                    departurePicker.input.value = flatpickr.formatDate(departDate, "d M Y");

                    // Update the return field ONLY when both dates are selected
                    if (selectedDates.length === 2) {
                        document.getElementById("returnDate").value = flatpickr.formatDate(selectedDates[1], "d M Y");
                    } else {
                        document.getElementById("returnDate").value = "";
                    }
                }
            }
        });

        // Initialize return date input (neutral, waits for user selection)
        const returnPicker = flatpickr("#returnDate", {
            dateFormat: "d M Y",
            minDate: today, // Updates dynamically but stays independent
            defaultDate: null, // Keeps field empty until user selects
        });
    });

document.addEventListener("DOMContentLoaded", () => {
    console.log("üîç Initializing flight search...");
    setupLoadingAnimation();
    populateLocations();
    setupBookingSubmission();
});

// üîÑ Setup Loading Animation Once
function setupLoadingAnimation() {
    const loadingOverlay = document.createElement("div");
    loadingOverlay.id = "loadingOverlay";
    loadingOverlay.style.display = "none";
    loadingOverlay.innerHTML = "<p>üîÑ Searching for flights...</p>";
    document.body.appendChild(loadingOverlay);
}

function showLoading() {
    document.getElementById("loadingOverlay").style.display = "block";
}

function hideLoading() {
    document.getElementById("loadingOverlay").style.display = "none";
}

// üåç Fetch Locations from PHP instead of Azure
function populateLocations() {
    const departureSelect = document.getElementById("takeOff");
    const destinationSelect = document.getElementById("arrival");
    const apiUrl = "http://localhost:5500/location.php"; // ‚úÖ PHP API call

    fetch(apiUrl)
        .then(response => {
            console.log("üì° Locations API Response:", response.status, response.statusText);
            if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log("üåç Locations Data:", data);
            if (!data.locations || !Array.isArray(data.locations)) throw new Error("No locations found.");
            populateDropdown(departureSelect, data.locations, "Select Departure");
            populateDropdown(destinationSelect, data.locations, "Select Destination");
        })
        .catch(error => {
            console.error("‚ùå Error fetching locations:", error);
            departureSelect.innerHTML = "<option>‚ö† Error loading locations</option>";
            destinationSelect.innerHTML = "<option>‚ö† Error loading locations</option>";
        });
}

function populateDropdown(dropdown, locations, defaultText) {
    dropdown.innerHTML = `<option disabled selected>${defaultText}</option>`;
    locations.forEach(location => {
        const option = document.createElement("option");
        option.value = location;
        option.textContent = location;
        dropdown.appendChild(option);
    });
}

// ‚úàÔ∏è Setup Booking Submission
function setupBookingSubmission() {
    const bookingForm = document.getElementById("bookingForm");

    if (!bookingForm) {
        console.error("‚ùå Booking form not found.");
        return;
    }

    bookingForm.addEventListener("submit", function (event) {
        event.preventDefault();
        showLoading();

        const departure = document.getElementById("takeOff").value;
        const destination = document.getElementById("arrival").value;

        if (!departure || !destination) {
            alert("‚ö† Please select both departure and destination.");
            hideLoading();
            return;
        }

        fetchFlightData(departure, destination);
    });
}

// ‚úàÔ∏è Fetch Flight Data from PHP Instead of Azure
function fetchFlightData(departure, destination) {
    const apiUrl = `http://localhost:5000/flights.php?departure=${encodeURIComponent(departure)}&destination=${encodeURIComponent(destination)}`; // ‚úÖ PHP API Integration

    console.log("üöÄ Fetching flight data:", apiUrl);

    fetch(apiUrl)
        .then(response => {
            console.log("üì° API Response Status:", response.status, response.statusText);
            if (!response.ok) throw new Error(`HTTP Error: ${response.status} - ${response.statusText}`);
            return response.text();
        })
        .then(text => {
            console.log("üîç Raw API Response:", text || "‚ö† Empty response");
            return text.trim() ? JSON.parse(text) : { results: [] };
        })
        .then(data => {
            hideLoading();
            if (!data.results || data.results.length === 0) {
                console.warn("‚ö† No flights found.");
                document.getElementById("results").innerHTML = "<p>‚ö† No flights found. Try adjusting your search criteria.</p>";
                return;
            }
            displayFlightResults(data.results);
        })
        .catch(error => {
            console.error("‚ùå API Fetch Error:", error);
            document.getElementById("results").innerHTML = `<p>‚ö† Unable to fetch flights. Check API availability.</p>`;
            hideLoading();
        });
}

// üé´ Display Flight Results
function displayFlightResults(flights) {
    const resultsContainer = document.getElementById("results");
    resultsContainer.innerHTML = "";

    if (!flights || flights.length === 0) {
        resultsContainer.innerHTML = "<p>No flights found. Please try another search.</p>";
        return;
    }

    flights.forEach(flight => {
        const flightElement = document.createElement("div");
        flightElement.className = "flight-card";
        flightElement.innerHTML = `
            <h3>${flight.airline} - ${flight.flightNumber}</h3>
            <p><strong>From:</strong> ${flight.from} ‚Üí <strong>To:</strong> ${flight.to}</p>
            <p><strong>Price:</strong> ${flight.price} PHP</p>
            <p><strong>Departure:</strong> ${new Date(flight.departureTime).toLocaleString()}</p>
            <p><strong>Arrival:</strong> ${new Date(flight.arrivalTime).toLocaleString()}</p>
            <button onclick="confirmBooking('${flight.id}')">Confirm Booking</button>
        `;
        resultsContainer.appendChild(flightElement);
    });
}

      document.getElementById("bookingForm").addEventListener("submit", function(event) {
          event.preventDefault(); // Prevent actual submission

          // Save values to LocalStorage
          localStorage.setItem("from", document.getElementById("takeOff").value);
          localStorage.setItem("to", document.getElementById("arrival").value);
          localStorage.setItem("departureDate", document.getElementById("departureDate").value);
          localStorage.setItem("returnDate", document.getElementById("returnDate").value);

          // Redirect to confirmation page
          window.location.href = "confirmation.html";
      });

      // To proceed to the hidden html
      function proceedToNextPage() {
          console.log("‚úÖ Redirecting to confirmation page...");
          window.location.href = "confirmation.html";
      }

        // To detect user location
        function detectUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
            } else {
                console.error("‚ùå Geolocation is not supported.");
                setDefaultDeparture();
            }
        }

        function successCallback(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            console.log(`üìç User Location: ${latitude}, ${longitude}`);

            // Reverse geocoding to fetch the country
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`)
                .then(response => response.json())
                .then(data => {
                    const country = data.address.country || "Philippines"; // Default fallback
                    console.log(`üåç Detected Country: ${country}`);
                    document.getElementById("takeOff").value = country;
                })
                .catch(error => {
                    console.error("‚ùå Location fetch failed:", error);
                    setDefaultDeparture();
                });
        }

        function errorCallback(error) {
            console.error("‚ùå Geolocation Error:", error.message);
            setDefaultDeparture();
        }

        function setDefaultDeparture() {
            document.getElementById("takeOff").value = "Philippines"; // Fallback location
        }

        // Call this function inside `DOMContentLoaded`
        document.addEventListener("DOMContentLoaded", detectUserLocation);

      fetch("Footer/footer.html")
        .then(response => response.text())
        .then(data => {
          document.getElementById("footer-placeholder").innerHTML = data;
        });
  </script>
</body>
</html>